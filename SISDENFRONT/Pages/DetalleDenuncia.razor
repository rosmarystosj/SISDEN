@page "/detalle-denuncia/{id:int}"
@layout NavLay
@inject LoginModelService LoginModel
@inject RegistroEntidadService RegistroServiceEntidad
@inject RegistroDenuncianteService RegistroService
@inject DenunciasService DenunciasService
@inject EntidadService EntidadService
@inject ArticulosService ArticulosService
@inject Comentarios ComentarioService
@using System.ComponentModel.DataAnnotations

<body> 
    <div class="loader-wrapper">
      <div class="loader"> 
        <div class="loader4"></div>
      </div>
    </div>
    <div class="tap-top"><i data-feather="chevrons-up"></i></div>
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
     <div class="page-body-wrapper">
        <div class="page-body">
          <div class="container-fluid">
            <div class="page-title">
              <div class="row">
                            <div class="col-6">
                            </div>
                <div class="col-6">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/index">                                       
                        <svg class="stroke-icon">
                          <use href="../assets/svg/icon-sprite.svg#stroke-home"></use>
                        </svg></a></li>
                       <li class="breadcrumb-item"><a href="/denuncias"> Ver Denuncias</a></li>
                    <li class="breadcrumb-item active">Detalle Denuncia</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
          <div class="container-fluid">
              <div class="row product-page-main p-0">
                <div class="col-xxl-5 box-col-6 order-xxl-0 order-1">
                  <div class="card">
                    <div class="card-body">
                      <div class="product-page-details">
                        <h3>@denuncias.Dentitulo</h3>
                      </div>
                      <div class="product-price">@denuncias.Dencategoria
                      </div>
                      <ul class="product-color">
                        <li class="bg-primary"></li>
                        <li class="bg-secondary"></li>
                        <li class="bg-success"></li>
                        <li class="bg-info"></li>
                        <li class="bg-warning"></li>
                      </ul>
                      <hr>
                      <p>@denuncias.Dendescripcion</p>
                      <hr>
                      <div>
                        <table class="product-page-width">
                          <tbody>
                            <tr>
                              <td> <b>Animal &nbsp;&nbsp;&nbsp;:</b></td>
                              <td>@denuncias.Denanimal</td>
                            </tr>
                            <tr>
                              <td> <b>Estatus &nbsp;&nbsp;&nbsp;: &nbsp;&nbsp;&nbsp;</b></td>
                              <td class="txt-success">@denuncias.Estado</td>
                            </tr>
                            <tr>
                              <td> <b>Fecha de Creación &nbsp;&nbsp;&nbsp;: &nbsp;&nbsp;&nbsp;</b></td>
                              <td>@denuncias.Denfechacreacion?.ToString("yyyy-MM-dd")</td>
                            </tr>
                            <tr>
                              <td> <b>Ubicación &nbsp;&nbsp;&nbsp;: &nbsp;&nbsp;&nbsp;</b></td>
                               <td>@denuncias.Denubicacion</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <hr>
                      <div class="m-t-15 btn-showcase">
                          <a class="btn btn-primary" href="/evidencia/@denuncias.Iddenuncia" title=""> <i class="fa icon-eye"></i> Ver evidencia</a>
                                        <a class="btn btn-success" href="checkout.html" title=""> <i class="iconfont iconfoint-tick-boxed "></i> Cerrar denuncia</a>
                          </div>
                    </div>
                  </div>
                </div>
                </div>

           <div class="row product-page-main p-0">
            <div class="col-xxl-5 box-col-6 order-xxl-0 order-1">
                <div class="card">
                    <div class="card-body">
                        <div class="product-page-details">
                            <h4>Datos del denunciante</h4>
                        </div>
                        <hr>

                        <div>
                            <table class="product-page-width">
                                <tbody>
                                    <tr>
                                        <td> <b>Nombre &nbsp;&nbsp;&nbsp;:</b></td>
                                        <td>@denuncias.UsuarioNombreCompleto</td>
                                    </tr>
                                    <tr>
                                        <td> <b>Cédula &nbsp;&nbsp;&nbsp;: &nbsp;&nbsp;&nbsp;</b></td>
                                        <td class="txt-success">@denuncias.CedulaUsuario</td>
                                    </tr>
                                    <tr>
                                        <td> <b>Correo &nbsp;&nbsp;&nbsp;: &nbsp;&nbsp;&nbsp;</b></td>
                                        <td>@denuncias.UsuarioEmail</td>
                                    </tr>
                                    <tr>
                                        <td> <b>Teléfono &nbsp;&nbsp;&nbsp;: &nbsp;&nbsp;&nbsp;</b></td>
                                        <td>@denuncias.UsuarioTelefono</td>
                                    </tr>
                                </tbody>
                            </table>
                         </div>
                    </div>
                  </div>
               </div>
              </div>
           </div>
            <div class="card">
              <div class="row product-page-main">
                <div class="col-sm-12">
                  <ul class="nav nav-tabs border-tab nav-primary mb-0" id="top-tab" role="tablist">
                    <li class="nav-item"><a class="nav-link active" id="top-home-tab" data-bs-toggle="tab" href="#top-home" role="tab" aria-controls="top-home" aria-selected="false">Articulos Violados</a>
                      <div class="material-border"></div>
                    </li>
                    <li class="nav-item"><a class="nav-link" id="profile-top-tab" data-bs-toggle="tab" href="#top-profile" role="tab" aria-controls="top-profile" aria-selected="false">Detalle</a>
                      <div class="material-border"></div>
                    </li>
                   
                  </ul>
                  <div class="tab-content" id="top-tabContent">
                     <div class="tab-pane fade active show" id="top-home" role="tabpanel" aria-labelledby="top-home-tab">
                       @if (articulo.Any(a => a.Artnombre != null))
                      {
                      @foreach (var articulos in articulo)
                        {
                            <b>@articulos.Artnombre</b>
                            <p class="mb-0 m-t-20"> @articulos.Artdescripcion</p>
                        }

                        }else
                        {
                        <p>No hay articulos violados</p>

                    }
                </div>
                      <div class="tab-pane fade" id="top-profile" role="tabpanel" aria-labelledby="profile-top-tab">

                    @if (articulo.Any(a => a.Puntoartdescripcion != null && a.Puntoartnumero != null))
                    {
                        @foreach (var articulos in articulo)
                        {
                            if (articulos.Puntoartdescripcion != null && articulos.Puntoartnumero != null)
                            {
                                <div>
                                    <b>@articulos.Artnombre</b>
                                    <b>Punto @articulos.Puntoartnumero</b>
                                    <p class="mb-0 m-t-20">@articulos.Puntoartdescripcion</p>
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <p>No hay detalle de articulo</p>
                    }
                    
                     </div>

                  </div>
                </div>
              </div>
            </div>

                <div class="col-xl-6 xl-60 col-lg-12 col-md-7 box-col-8e">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="new-users-social">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h4 class="mb-0 f-w-700">Comentarios</h4>
                                        </div>
                                        <span class="pull-right mt-0">
                                            <i data-feather="more-vertical"></i>
                                        </span>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="social-chat">
                                            @foreach (var comentario in comentarios)
                                            {
                                                <div class="your-msg">
                                                    <div class="d-flex">
                                                        @if (comentario.Idrol == 1)
                                                        {
                                                            <img class="img-50 img-fluid m-r-20 rounded-circle" alt="" src="~/assets/images/user/Imagen de WhatsApp 2024-08-08 a las 18.36.45_603fcb86.jpg">
                                                        }
                                                        else if (comentario.Idrol == 2)
                                                        {
                                                            <img class="img-50 img-fluid m-r-20 rounded-circle" alt="" src="~/assets/images/user/Imagen de WhatsApp 2024-08-08 a las 18.37.13_699fa5bc.jpg">
                                                        }
                                                        <div class="flex-grow-1">
                                                            <span class="f-w-600">@denuncias.UsuarioNombreCompleto <span>@comentario.ComFecha?.ToString("MMMM, dd, yyyy") <i class="fa fa-reply font-primary"></i></span></span>
                                                            <p>@comentario.Comdescripcion</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                         <EditForm Model="newComentario">
                                        <div class="comments-box">
                                            <div class="d-flex">
                                                @if (LoginModel.LoginModel?.UsuRol == 1 && RegistroService.RegistroModelo?.Usurol == 1)
                                                {
                                                    <img class="img-50 img-fluid m-r-20 rounded-circle" alt="" src="~/assets/images/user/Imagen de WhatsApp 2024-08-08 a las 18.36.45_603fcb86.jpg">
                                                }
                                                else if (LoginModel.LoginModel?.UsuRol == 2 && RegistroServiceEntidad.EntidadModelo?.Usurol == 2)
                                                {
                                                    <img class="img-50 img-fluid m-r-20 rounded-circle" alt="" src="~/assets/images/user/Imagen de WhatsApp 2024-08-08 a las 18.37.13_699fa5bc.jpg">
                                                }
                                                
                                                <div class="flex-grow-1">
                                                    <div class="input-group text-box">
                                                        <input class="form-control input-txt-bx" type="text" @bind="newComentario.Comdescripcion" placeholder="Escribe tu Comentario...">
                                                          <button class="btn btn-primary" type="button" @onclick="AgregarComentario">Enviar</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                       </EditForm>

                                        @if (showSuccessMessage)
                                        {
                                            <div class="alert alert-success mt-2">
                                                Comentario agregado con éxito.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
           </div>
         </div>

        <footer class="footer">
          <div class="container-fluid">
            <div class="row">
              <div class="col-md-12 footer-copyright text-center">
                <p class="mb-0">Copyright 2024 © Riho theme by pixelstrap  </p>
              </div>
            </div>
          </div>
        </footer>
    </div>
    </div>

</body>

@code {
    [Parameter]
    public int Id { get; set; }
    private VistaDenuncia denuncias;
    private List<VistaViolacione> articulo;
    private List<VistaComentario> comentarios = new();
    private ComentarioDTO newComentario = new();
    private bool showSuccessMessage = false; 

    protected override async Task OnInitializedAsync()
    {

        denuncias = new VistaDenuncia();
        articulo = new List<VistaViolacione>();
        comentarios = new  List<VistaComentario>();

        try
        {
            denuncias = await DenunciasService.GetDenunciaById(Id);
            articulo = await ArticulosService.GetArticuloById(denuncias.Iddenuncia);
            comentarios = await ComentarioService.GetCommentsByDenunciaId(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }
    private async Task AgregarComentario()
    {
        newComentario.ComIddenuncia = Id;
        newComentario.ComIdusuario = denuncias.Idusuario ?? 0;
        newComentario.ComIdrol = denuncias.Usurol;

        await ComentarioService.AddComment(newComentario);
        comentarios = await ComentarioService.GetCommentsByDenunciaId(Id);
        newComentario = new ComentarioDTO(); 
        showSuccessMessage = true; 
        StateHasChanged(); 
        await Task.Delay(3000);
        showSuccessMessage = false;
        StateHasChanged(); 
    }

}
